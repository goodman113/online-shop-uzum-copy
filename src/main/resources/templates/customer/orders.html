<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <title>User Orders</title>
    <style>
        /* üî• CORE RESET & BASE */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
        }

        /* üî• HEADER */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 40px;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo {
            font-size: 28px;
            font-weight: 800;
            color: #7c3aed;
            letter-spacing: -1px;
        }
        .logo span { color: #a78bfa; }

        .center-nav {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
            justify-content: center;
            max-width: 600px;
        }
        .categories-btn {
            background: #7c3aed;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        .categories-btn:hover { background: #6d28d9; transform: translateY(-2px); }

        .search-container {
            display: flex;
            flex: 1;
            max-width: 600px;
        }
        .search-container input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            border-right: none;
            border-radius: 8px 0 0 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }
        .search-container input:focus { border-color: #7c3aed; }
        .search-btn {
            background: #7c3aed;
            border: none;
            padding: 12px 20px;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            color: #fff;
            transition: background 0.3s;
        }
        .search-btn:hover { background: #6d28d9; }

        .right-nav {
            display: flex;
            align-items: center;
            gap: 25px;
        }
        .nav-icon {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #374151;
            cursor: pointer;
            transition: color 0.3s;
            text-decoration: none;
        }
        .nav-icon:hover { color: #7c3aed; }
        .nav-icon i { font-size: 22px; }
        .nav-icon span { font-size: 11px; font-weight: 500; }

        .cart-badge::after, .wishlist-badge::after {
            content: attr(data-count);
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            padding: 0 4px;
            z-index: 10;
        }
        .wishlist-badge::after { background: #7c3aed; }
        .cart-badge[data-count="0"]::after, .wishlist-badge[data-count="0"]::after { display: none; }

        /* üî• CATEGORIES SIDEBAR */
        .sidebar-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 200;
        }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }

        /* üî• CATEGORIES SIDEBAR (Mobile/Overlay) */
        .sidebar.categories-sidebar {
            position: fixed;
            top: 0;
            left: -320px;
            width: 320px;
            height: 100%;
            background: #fff;
            transition: left 0.3s;
            z-index: 201;
            overflow-y: auto;
        }
        .sidebar.categories-sidebar.active { left: 0; }

        /* üî• USER NAV SIDEBAR (Desktop/Fixed) */
        .sidebar.user-nav-sidebar {
            position: relative !important;  /* Override fixed positioning */
            left: 0 !important;           /* Always visible */
            width: 400px;
            background: #fff;
            padding: 40px 0;
            border-right: 1px solid #e5e7eb;
            z-index: 1;                   /* Low z-index, always behind */
        }

        /* üî• RESPONSIVE: Mobile User Sidebar */
        @media (max-width: 768px) {
            .sidebar.user-nav-sidebar {
                position: relative !important;
                width: 100% !important;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }
            .sidebar.categories-sidebar {
                left: -100%;
                width: 100%;
            }
            .sidebar.categories-sidebar.active {
                left: 0;
            }
        }
        .sidebar.active { left: 0; }

        .sidebar-header {
            padding: 20px;
            background: #7c3aed;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-header h3 { font-size: 18px; }
        .close-sidebar {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }

        /* üî• CATEGORY STYLES */
        .category-item, .subcategory-item { border-bottom: 1px solid #f3f4f6; }
        .category-link, .subcategory-link {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .category-link:hover, .subcategory-link:hover {
            background: #f9fafb;
            color: #7c3aed;
        }
        .category-link.active, .subcategory-link.active {
            background: #7c3aed;
            color: #fff;
        }

        .subcategory-menu {
            position: fixed;
            left: 320px;
            top: 0;
            width: 280px;
            height: 100%;
            background: #fff;
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            display: none;
            overflow-y: auto;
            z-index: 202;
        }
        .subcategory-menu.active { display: block; }

        .subsubcategory-menu {
            position: fixed;
            left: 600px;
            top: 0;
            width: 250px;
            height: 100%;
            background: #fff;
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            display: none;
            overflow-y: auto;
            z-index: 203;
        }
        .subsubcategory-menu.active { display: block; }

        .subcategory-menu-header, .subsubcategory-menu-header {
            padding: 20px;
            background: #f3f4f6;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }

        .subsubcategory-link {
            display: block;
            padding: 12px 20px;
            color: #374151;
            text-decoration: none;
            transition: all 0.2s;
            border-bottom: 1px solid #f3f4f6;
        }
        .subsubcategory-link:hover {
            background: #7c3aed;
            color: #fff;
        }

        .clickable-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        .clickable-header:hover {
            background: #7c3aed;
            color: #fff;
        }
        .clickable-header i { font-size: 14px; opacity: 0.7; }

        /* üî• MAIN LAYOUT */
        .container { display: flex; min-height: 100vh; }
        .sidebar.user-nav-sidebar {
            width: 400px;
            background: #fff;
            padding: 40px 0;
            border-right: 1px solid #e5e7eb;
        }
        .username {
            font-size: 32px;
            font-weight: 600;
            padding: 0 40px 40px;
            color: #1d1d1f;
        }
        .nav-menu { list-style: none; }
        .nav-item {
            padding: 16px 40px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 17px;
        }
        .nav-item:hover { background: #f5f5f7; }
        .nav-item.active { background: #e8e8ed; }
        .notification-dot {
            width: 8px; height: 8px;
            background: #7c3aed;
            border-radius: 50%;
        }

        .main-content {
            flex: 1;
            padding: 40px 60px;
            max-width: 1200px;
        }
        .content-section { display: none; }
        .content-section.active { display: block; }

        /* üî• FILTER TABS */
        .filter-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 40px;
        }
        .filter-tab {
            padding: 10px 24px;
            border-radius: 24px;
            background: #e8e8ed;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s;
            color: #1d1d1f;
        }
        .filter-tab:hover { background: #d2d2d7; }
        .filter-tab.active { background: #1d1d1f; color: #fff; }

        /* üî• ORDER CARDS */
        .orders-list { display: flex; flex-direction: column; gap: 16px; }
        .order-card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            transition: box-shadow 0.2s;
        }
        .order-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
        }
        .order-id { font-size: 17px; font-weight: 600; color: #1d1d1f; }
        .copy-icon {
            cursor: pointer;
            font-size: 18px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .copy-icon:hover { background: #f5f5f7; }

        .order-details { display: flex; flex-direction: column; gap: 12px; }
        .detail-row {
            display: grid;
            grid-template-columns: 180px 1fr;
            gap: 16px;
            align-items: start;
        }
        .detail-label { color: #6e6e73; font-size: 15px; }
        .detail-value {
            color: #1d1d1f;
            font-size: 15px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            width: fit-content;
        }
        .status-active { background: #10b981; color: white; }
        .status-unpaid { background: #f59e0b; color: white; }
        .status-taken { background: #3b82f6; color: white; }
        .status-returned { background: #ef4444; color: white; }
        .update-time { color: #6e6e73; font-size: 13px; }

        .payment-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e0e0e0;
        }
        .btn-pay {
            width: 100%;
            padding: 12px 24px;
            background: #7000FF;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-pay:hover { background: #5c00d6; }

        .review-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(124,58,237,0.3);
            margin-top: 12px;
        }
        .review-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(124,58,237,0.4);
        }

        /* üî• ORDER ITEMS */
        .order-items {
            margin-top: 24px;
            border-top: 1px solid #e5e7eb;
            padding-top: 24px;
        }
        .items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 12px 0;
        }
        .items-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: #1d1d1f;
        }
        .dropdown-icon {
            transition: transform 0.3s;
            color: #6e6e73;
            font-size: 18px;
        }
        .dropdown-icon.open { transform: rotate(180deg); }
        .items-list { display: none; padding-top: 16px; }
        .items-list.open { display: block; }
        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid #f5f5f7;
            font-size: 15px;
        }
        .item-name { color: #1d1d1f; font-weight: 500; }
        .item-quantity, .item-price { color: #6e6e73; }

        /* üî• REVIEWS & PROFILE */
        .review-card, .profile-card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
        }
        .review-header, .profile-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .review-product, .profile-label {
            font-size: 17px;
            font-weight: 600;
            color: #1d1d1f;
        }
        .review-rating { color: #fbbf24; font-size: 16px; }
        .review-date, .profile-value {
            color: #6e6e73;
            font-size: 14px;
        }
        .review-text { color: #1d1d1f; font-size: 15px; line-height: 1.5; }
        .profile-row {
            grid-template-columns: 150px 1fr;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid #f5f5f7;
        }
        .profile-value {
            color: #1d1d1f;
            font-weight: 500;
        }
        .profile-row:last-child { border-bottom: none; }

        /* üî• EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }
        .empty-state h2 {
            font-size: 48px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1d1d1f;
        }
        .empty-state p {
            font-size: 17px;
            color: #6e6e73;
            margin-bottom: 12px;
        }

        /* üî• MODALS - CONSOLIDATED */
        .modal-overlay, .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
        }
        .modal-overlay.active, .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .review-modal, .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }
        @keyframes slideIn {
            from { transform: translateY(-50px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px 0;
            margin-bottom: 20px;
        }
        .modal-header h2 {
            margin: 0;
            color: #1d1d1f;
            font-size: 24px;
            font-weight: 600;
        }
        .modal-close, .close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .modal-close:hover, .close:hover {
            background: #f5f5f7;
            color: #000;
        }

        .modal-body { padding: 0 24px 24px; }
        .product-info {
            display: flex;
            gap: 16px;
            padding: 20px 0;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 24px;
        }
        .product-info img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }

        /* üî• REVIEW FORM */
        .rating-section, .comment-section, .image-section, .form-group, .advantages-section, .disadvantages-section {
            margin-bottom: 24px;
        }
        .rating-section label, .comment-section label, .form-group label, .advantages-section label, .disadvantages-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1d1d1f;
            font-size: 14px;
        }
        .star-rating { display: flex; gap: 4px; }
        .star-rating i {
            font-size: 24px;
            color: #d1d5db;
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-rating i.fas { color: #f59e0b; }
        #ratingText {
            color: #6b7280;
            font-size: 14px;
            margin-top: 8px;
            display: block;
        }

        .advantages-section {
            border-left: 4px solid #10b981;
            background: #f0fdf4;
            padding: 16px;
            border-radius: 8px;
        }
        .disadvantages-section {
            border-left: 4px solid #ef4444;
            background: #fef2f2;
            padding: 16px;
            border-radius: 8px;
        }

        .advantages-section textarea, .disadvantages-section textarea, #reviewComment, .form-group input, .form-group textarea {
            background: #fff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 16px;
            font-family: inherit;
            font-size: 15px;
            line-height: 1.6;
            resize: vertical;
            min-height: 80px;
            width: 100%;
            transition: all 0.2s;
            box-sizing: border-box;
        }
        .advantages-section textarea:focus, .disadvantages-section textarea:focus, #reviewComment:focus, .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124,58,237,0.1);
        }
        .form-group input {
            min-height: auto;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .form-group input:focus { border-color: #7000FF; }

        .char-count {
            text-align: right;
            margin-top: 6px;
            font-size: 13px;
            color: #6b7280;
        }
        .char-count span { font-weight: 500; }

        .image-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafafa;
        }
        .image-upload-area:hover {
            border-color: #7c3aed;
            background: #f8faff;
        }
        .image-upload-area i { font-size: 32px; color: #6e6e73; margin-bottom: 12px; }
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }
        .image-preview {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
        }
        .image-preview img { width: 100%; height: 100%; object-fit: cover; }
        .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            padding: 20px 24px;
            border-top: 1px solid #e5e7eb;
        }
        .btn-cancel, .btn-submit {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .btn-cancel { background: #f5f5f7; color: #1d1d1f; }
        .btn-cancel:hover { background: #e5e7eb; }
        .btn-submit {
            background: #7c3aed;
            color: white;
        }
        .btn-submit:hover:not(:disabled) { background: #6d28d9; }
        .btn-submit:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* üî• PAYMENT SPECIFIC */
        .payment-info {
            background: #f5f5f5;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .info-label { color: #666; font-size: 14px; }
        .info-value { color: #333; font-weight: 600; font-size: 14px; }

        .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
            min-height: 16px;
            display: block;
        }

        .verification-message {
            background: #e0f2fe;
            color: #0369a1;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 20px;
            text-align: center;
        }
        .timer-container {
            text-align: center;
            margin: 16px 0;
        }
        .timer-text { color: #666; font-size: 14px; }
        #timer { font-weight: 600; color: #7000FF; }

        .btn-resend {
            width: 100%;
            padding: 14px;
            background: #fff;
            color: #7000FF;
            border: 2px solid #7000FF;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 12px;
        }
        .btn-resend:hover {
            background: #7000FF;
            color: white;
        }
        .btn-resend:disabled {
            background: #f5f5f5;
            color: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
        }

        /* üî• TOAST */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(16,185,129,0.3);
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }
        .toast.error {
            background: #ef4444;
            box-shadow: 0 10px 30px rgba(239,68,68,0.3);
        }
        .toast.show { transform: translateX(0); }
        .toast i { font-size: 18px; }

        /* üî• RESPONSIVE */
        @media (max-width: 768px) {
            .header { padding: 15px 20px; }
            .container { flex-direction: column; }
            .sidebar.user-nav-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }
            .main-content { padding: 20px; }
            .detail-row, .item-row, .profile-row { grid-template-columns: 1fr; gap: 4px; }
            .center-nav { gap: 10px; }
            .search-container { max-width: 300px; }
            .sidebar.categories-sidebar { left: -100%; width: 100%; }
            .subcategory-menu, .subsubcategory-menu { left: 0; width: 100%; }
        }

        .review-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .review-status.reviewed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .review-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .review-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .review-card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .product-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .product-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
        }

        .review-pros-cons {
            margin: 16px 0;
        }

        .review-pros, .review-cons {
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 8px;
        }

        .review-pros {
            background: #f0fdf4;
            border-left: 4px solid #22c55e;
        }

        .review-cons {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }

        .review-images {
            display: flex;
            gap: 10px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .review-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
        }

        .seller-reply {
            background: #eff6ff;
            border: 1px solid #dbeafe;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .reply-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1e40af;
        }

        .review-rating i {
            color: #fbbf24;
            font-size: 16px;
        }

        .filter-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 12px;
        }
    </style>
</head>
<body>
<!-- üî• HEADER -->
<header class="header">
    <div class="logo">Ali <span>Market</span></div>
    <div class="center-nav">
        <button class="categories-btn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i> Categories
        </button>
        <div class="search-container">
            <form method="get" action="/" style="max-width: 600px; width: 100%;">
                <input type="text" name="name" placeholder="Search products..." id="searchInput" th:value="${param.name}">
                <button type="submit" class="search-btn"><i class="fas fa-search"></i></button>
            </form>
        </div>
    </div>
    <div class="right-nav">
        <a href="/login" class="nav-icon">
            <i class="fas fa-user"></i>
            <span>Login</span>
        </a>
        <a href="/orders?filter=all" class="nav-icon">
            <i class="fas fa-box"></i>
            <span>Orders</span>
        </a>
        <a href="/wishlist" class="nav-icon wishlist-badge" th:attr="data-count=${wishlistCount}" id="wishlistBadge">
            <i class="fas fa-heart"></i>
            <span>Wishlist</span>
        </a>
        <a href="/cart" class="nav-icon cart-badge" data-count="0" id="cartBadge">
            <i class="fas fa-shopping-cart"></i>
            <span>Cart</span>
        </a>
    </div>
</header>

<!-- üî• CATEGORIES SIDEBAR -->
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>
<aside class="sidebar categories-sidebar">
    <div class="sidebar-header">
        <h3>Categories</h3>
        <button class="close-sidebar" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
    </div>
    <nav class="categories-list">
        <div class="category-item" th:each="entry, catStat : ${categories}">
            <div class="category-link" th:data-index="${catStat.index}" th:data-name="${entry.key.name}" onclick="toggleCategory(this)">
                <span th:text="${entry.key.name}">Electronics</span>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div class="subcategory-menu" th:id="'subcategory-menu-' + ${catStat.index}">
                <div class="subcategory-menu-header clickable-header"
                     th:data-name="${entry.key.name}"
                     onclick="sendCategoryToBackend(this)">
                    <span th:text="${entry.key.name}">Category Name</span>
                    <i class="fas fa-arrow-right"></i>
                </div>
                <div class="subcategory-item" th:each="subCat, subStat : ${entry.value}">
                    <div class="subcategory-link" th:data-cat-index="${catStat.index}" th:data-index="${subStat.index}" th:data-name="${subCat.name}" onclick="toggleSubCategory(this)">
                        <span th:text="${subCat.name}">Phones</span>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="subsubcategory-menu" th:id="'subsubcategory-menu-' + ${catStat.index} + '-' + ${subStat.index}">
                        <div class="subsubcategory-menu-header clickable-header"
                             th:data-name="${subCat.name}"
                             onclick="sendSubCategoryToBackend(this)">
                            <span th:text="${subCat.name}">SubCategory Name</span>
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        <a th:each="subSubCat : ${subCat.subSubCategories}"
                           th:href="@{/products(subSubCategoryId=${subSubCat.id})}"
                           th:text="${subSubCat.name}" class="subsubcategory-link">Smartphones</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
</aside>

<div class="container">
    <!-- üî• USER SIDEBAR -->
    <aside class="sidebar user-nav-sidebar">
        <h1 class="username" th:text="${user.username}">Muhammadali Yoqubjonov</h1>
        <ul class="nav-menu">
            <li class="nav-item active" onclick="showSection('orders')">
                <span>–ó–∞–∫–∞–∑—ã</span>
            </li>
            <li class="nav-item" onclick="showSection('reviews')">
                <span>–û—Ç–∑—ã–≤—ã</span>
                <span class="notification-dot"></span>
            </li>
            <li class="nav-item" onclick="showSection('profile')">
                <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
            </li>
        </ul>
    </aside>

    <!-- üî• MAIN CONTENT -->
    <main class="main-content">
        <!-- üî• ORDERS -->
        <div id="orders" class="content-section active">
            <div class="filter-tabs">
                <button class="filter-tab" onclick="filterOrders('all')" th:classappend="${filter == 'all'} ? 'active' : ''">–í—Å–µ –∑–∞–∫–∞–∑—ã</button>
                <button class="filter-tab" onclick="filterOrders('unpaid')" th:classappend="${filter == 'unpaid'} ? 'active' : ''">–ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ</button>
                <button class="filter-tab" onclick="filterOrders('active')" th:classappend="${filter == 'active'} ? 'active' : ''">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
            </div>

            <div class="empty-state" th:if="${#lists.isEmpty(orders)}">
                <h2>–ó–¥–µ—Å—å –ø—É—Å—Ç–æ</h2>
                <p>–£ –≤–∞—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã!</p>
                <p>–í–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –ø–æ–∏—Å–∫–æ–º, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –≤—Å—ë —á—Ç–æ –Ω—É–∂–Ω–æ.</p>
            </div>

            <div class="orders-list">
                <div class="order-card" th:each="order : ${orders}">
                    <div class="order-header">
                        <span class="order-id">ID –∑–∞–∫–∞–∑–∞ <span th:text="${order.id}">56806718</span></span>
                        <span class="copy-icon" onclick="copyOrderId(this)" title="Copy">üìã</span>
                    </div>

                    <div class="order-details">
                        <div class="detail-row">
                            <span class="detail-label">–°—Ç–∞—Ç—É—Å:</span>
                            <div class="detail-value">
            <span class="status-badge"
                  th:classappend="${order.status.name() == 'CANCELLED'} ? 'status-returned' :
                                 (${order.status.name() == 'UNPAID'} ? 'status-unpaid' :
                                 (${order.status.name() == 'TAKEN_BY_CUSTOMER'} ? 'status-taken' : 'status-active'))"
                  th:text="${order.status}">–í–æ–∑–≤—Ä–∞—â—ë–Ω</span>
                                <span class="update-time" th:text="'–û–±–Ω–æ–≤–ª–µ–Ω ' +${#temporals.format(order.updatedAt, 'yyyy/MM/dd HH:mm:ss')}">2025/05/05 09:53:00</span>
                            </div>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞:</span>
                            <span class="detail-value" th:text="${#temporals.format(order.createdAt, 'yyyy/MM/dd HH:mm:ss')}">2025/04/28 22:24:00</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞:</span>
                            <span class="detail-value" th:text="${order.totalPrice} + ' —Å—É–º'">24 000 —Å—É–º</span>
                        </div>
                    </div>

                    <div th:if="${order.status == T(project.model.enums.OrderStatus).UNPAID and order.payingMethod == T(project.model.enums.PayingMethod).CARD}" class="payment-section">
                        <button class="btn-pay"
                                th:attr="data-order-id=${order.id}, data-amount=${order.totalPrice}"
                                onclick="openPaymentModal(this)">
                            –û–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑
                        </button>
                    </div>

                    <div class="order-items">
                        <div class="items-header" onclick="toggleItems(this)">
                            <h3><span th:text="${#lists.size(order.items)}">1</span> —Ç–æ–≤–∞—Ä</h3>
                            <span class="dropdown-icon">‚åÑ</span>
                        </div>
                        <div class="items-list">
                            <div class="item-row" th:each="item : ${order.items}">
                                <!-- ‚úÖ Product details (ALWAYS SHOW) -->
                                <span class="item-name" th:text="${item.product.name}">Product Name</span>
                                <span class="item-quantity" th:text="${item.quantity} + ' —à—Ç.'">1 —à—Ç.</span>
                                <span class="item-price" th:text="${item.price} + ' —Å—É–º'">24 000 —Å—É–º</span>
                                <!-- ‚úÖ CHECK IF USER ALREADY REVIEWED THIS PRODUCT -->
                                <th:block th:each="product : ${productsUserReviewed}">
                                    <th:block th:if="${product.id == item.product.id}">
                                        <!-- ‚ùå ALREADY REVIEWED -->
                                        <div class="review-status reviewed">
                                            <i class="fas fa-check-circle"></i>
                                            <span>–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–∏–ª–∏ –æ—Ç–∑—ã–≤</span>
                                        </div>
                                    </th:block>
                                </th:block>

                                <!-- ‚úÖ SHOW REVIEW BUTTON ONLY IF NOT REVIEWED + TAKEN_BY_CUSTOMER -->
                                <th:block th:if="${order.status.name() == 'TAKEN_BY_CUSTOMER'}">
                                    <th:block th:each="product : ${productsUserReviewed}">
                                        <th:block th:if="${product.id != item.product.id}">
                                            <button class="review-btn"
                                                    th:attr="data-product-id=${item.product.id},
                                     data-product-name=${item.product.name},
                                     data-product-image=${item.product.imageProducts != null && !item.product.imageProducts.isEmpty() ? item.product.imageProducts[0].path : '/images/placeholder.jpg'},
                                     data-order-id=${order.id}"
                                                    onclick="openReviewModal(this)">
                                                <i class="fas fa-star"></i> –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
                                            </button>
                                        </th:block>
                                    </th:block>
                                </th:block>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- üî• REVIEWS -->
        <div id="reviews" class="content-section">
            <h2 style="font-size: 32px; font-weight: 600; margin-bottom: 24px;">–ú–æ–∏ –æ—Ç–∑—ã–≤—ã</h2>

            <!-- üî• REVIEWS FILTERS -->
            <div class="filter-tabs">
                <button class="filter-tab" onclick="filterReviews('all')" th:classappend="${reviewFilter == 'all'} ? 'active' : ''">–í—Å–µ –æ—Ç–∑—ã–≤—ã</button>
                <button class="filter-tab" onclick="filterReviews('replied')" th:classappend="${reviewFilter == 'replied'} ? 'active' : ''">–° –æ—Ç–≤–µ—Ç–æ–º</button>
                <button class="filter-tab" onclick="filterReviews('unreplied')" th:classappend="${reviewFilter == 'unreplied'} ? 'active' : ''">–ë–µ–∑ –æ—Ç–≤–µ—Ç–∞</button>
            </div>

            <div class="review-card" th:each="review : ${filteredReviews}">
                <div class="review-header">
                    <div class="product-info">
                        <img th:src="${review.product.imageProducts != null && !review.product.imageProducts.isEmpty() ? review.product.imageProducts[0].path : '/images/placeholder.jpg'}"
                             alt="Product" class="product-image">
                        <span class="review-product" th:text="${review.product.name}">Product Name</span>
                    </div>
                    <span class="review-rating">
                <i class="fas" th:class="'fa-star' + (${review.rating >= 1} ? '' : '-o')"></i>
                <i class="fas" th:class="'fa-star' + (${review.rating >= 2} ? '' : '-o')"></i>
                <i class="fas" th:class="'fa-star' + (${review.rating >= 3} ? '' : '-o')"></i>
                <i class="fas" th:class="'fa-star' + (${review.rating >= 4} ? '' : '-o')"></i>
                <i class="fas" th:class="'fa-star' + (${review.rating >= 5} ? '' : '-o')"></i>
                <span th:text="(${review.rating} > 0) ? review.rating + '/5' : ''"></span>
            </span>
                </div>

                <!-- üî• ADVANTAGES & DISADVANTAGES -->
                <div class="review-pros-cons">
                    <div class="review-pros" th:if="${review.advantages != null && !review.advantages.isEmpty()}">
                        <strong>‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:</strong>
                        <p th:text="${review.advantages}">–û—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ</p>
                    </div>
                    <div class="review-cons" th:if="${review.disadvantages != null && !review.disadvantages.isEmpty()}">
                        <strong>‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:</strong>
                        <p th:text="${review.disadvantages}">–¶–µ–Ω–∞ –≤—ã—Å–æ–∫–∞—è</p>
                    </div>
                </div>

                <!-- üî• COMMENT -->
                <p class="review-text" th:if="${review.comment != null && !review.comment.isEmpty()}"
                   th:text="'your comment: '+${review.comment}">Great product! Highly recommend.</p>

                <!-- üî• IMAGES -->
                <div class="review-images" th:if="${review.images != null && !review.images.isEmpty()}">
                    <img th:each="image : ${review.images}"
                         th:src="${image.path}"
                         alt="Review image"
                         class="review-image">
                </div>

                <!-- üî• SELLER REPLY -->
                <div class="seller-reply" th:if="${review.replyToReview != null}">
                    <div class="reply-header">
                        <i class="fas fa-reply"></i>
                        <strong>–û—Ç–≤–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞:</strong>
                    </div>
                    <p class="reply-text" th:text="${review.replyToReview.reply}">–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤!</p>
                    <span class="reply-date" th:text="${#temporals.format(review.replyToReview.createdAt, 'yyyy/MM/dd HH:mm:ss')}">2025/11/30 15:30:00</span>
                </div>

                <div class="review-date" th:text="${#temporals.format(review.createdAt, 'yyyy/MM/dd HH:mm:ss')}">2025/11/30 14:23:45</div>
            </div>

            <div class="empty-state" th:if="${#lists.isEmpty(filteredReviews)}">
                <h2>–ó–¥–µ—Å—å –ø—É—Å—Ç–æ</h2>
                <p th:text="${reviewFilter == 'replied'} ? '–£ –≤–∞—Å –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ —Å –æ—Ç–≤–µ—Ç–æ–º –ø—Ä–æ–¥–∞–≤—Ü–∞' :
                     (${reviewFilter == 'unreplied'} ? '–£ –≤–∞—Å –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞' : '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤')">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</p>
            </div>
        </div>
        <!-- üî• PROFILE -->
        <div id="profile" class="content-section">
            <h2 style="font-size: 32px; font-weight: 600; margin-bottom: 24px;">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <div class="profile-card">
                <div class="profile-row">
                    <span class="profile-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</span>
                    <span class="profile-value" th:text="${user.username}">Muhammadali Yoqubjonov</span>
                </div>
                <div class="profile-row">
                    <span class="profile-label">Email:</span>
                    <span class="profile-value" th:text="${user.email}">user@example.com</span>
                </div>
                <div class="profile-row">
                    <span class="profile-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                    <span class="profile-value" th:text="${user.phone}">+998 90 123 45 67</span>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- üî• REVIEW MODAL -->
<div class="modal-overlay" id="reviewModal">
    <div class="review-modal">
        <div class="modal-header">
            <h2>–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h2>
            <button class="modal-close" onclick="closeReviewModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="product-info">
                <img src="/images/placeholder.jpg" alt="Product" id="modalProductImage">
                <div>
                    <h3 id="modalProductName">Product Name</h3>
                </div>
            </div>

            <div class="rating-section">
                <label>–û—Ü–µ–Ω–∫–∞ —Ç–æ–≤–∞—Ä–∞ <span style="color: #ef4444;">*</span></label>
                <div class="star-rating" id="starRating">
                    <i class="far fa-star" data-rating="1" onclick="setRating(1)"></i>
                    <i class="far fa-star" data-rating="2" onclick="setRating(2)"></i>
                    <i class="far fa-star" data-rating="3" onclick="setRating(3)"></i>
                    <i class="far fa-star" data-rating="4" onclick="setRating(4)"></i>
                    <i class="far fa-star" data-rating="5" onclick="setRating(5)"></i>
                </div>
                <small id="ratingText">–ü–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É</small>
            </div>

            <div class="advantages-section">
                <label>–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞</label>
                <textarea id="reviewAdvantages" placeholder="–ß—Ç–æ –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å –≤ —Ç–æ–≤–∞—Ä–µ?" maxlength="500" oninput="updateAdvantagesCount()"></textarea>
                <div class="char-count"><span id="advantagesCount">0</span>/500</div>
            </div>

            <div class="disadvantages-section">
                <label>–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏</label>
                <textarea id="reviewDisadvantages" placeholder="–ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å?" maxlength="500" oninput="updateDisadvantagesCount()"></textarea>
                <div class="char-count"><span id="disadvantagesCount">0</span>/500</div>
            </div>

            <div class="comment-section">
                <label>–í–∞—à –æ—Ç–∑—ã–≤ <span style="color: #ef4444;">*</span></label>
                <textarea id="reviewComment" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–≤–æ–∏—Ö –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è—Ö..." maxlength="1000" oninput="updateCharCount()"></textarea>
                <div class="char-count"><span id="charCount">0</span>/1000</div>
            </div>

            <div class="image-section">
                <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ–≤–∞—Ä–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <div class="image-upload-area" onclick="document.getElementById('imageInput').click()">
                    <i class="fas fa-camera"></i>
                    <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</p>
                    <small>–î–æ 6 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π, –º–∞–∫—Å–∏–º—É–º 5MB –∫–∞–∂–¥–∞—è</small>
                </div>
                <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" onchange="handleImageUpload(event)">
                <div class="image-preview-container" id="imagePreviewContainer"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeReviewModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn-submit" id="submitReviewBtn" onclick="submitReview()" disabled>
                <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
            </button>
        </div>
    </div>
</div>

<!-- üî• PAYMENT MODAL -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closePaymentModal()">&times;</span>
        <h2><i class="fas fa-credit-card"></i> –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</h2>
        <div class="payment-info">
            <div class="info-row">
                <span class="info-label">ID –∑–∞–∫–∞–∑–∞:</span>
                <span class="info-value" id="modalOrderId">‚Äî</span>
            </div>
            <div class="info-row">
                <span class="info-label">–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                <span class="info-value" id="modalAmount">‚Äî</span>
            </div>
        </div>

        <form id="paymentForm" onsubmit="submitPayment(event)">
            <div class="form-group">
                <label>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã <span style="color: #ef4444;">*</span></label>
                <input type="text" id="cardNumber" placeholder="0000 0000 0000 0000" maxlength="19" required oninput="formatCardNumber(this)">
                <span class="error-message" id="cardError"></span>
            </div>
            <div class="form-group">
                <label>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è <span style="color: #ef4444;">*</span></label>
                <input type="text" id="expireDate" placeholder="MM/YY" maxlength="5" required oninput="formatExpireDate(this)">
                <span class="error-message" id="expireError"></span>
            </div>
            <button type="submit" class="btn-submit" id="paymentSubmitBtn">
                <i class="fas fa-lock"></i> –û–ø–ª–∞—Ç–∏—Ç—å
            </button>
        </form>

        <div id="verificationSection" style="display: none;">
            <div class="verification-message">
                <i class="fas fa-check-circle"></i>
                <strong>–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!</strong><br>
                –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SMS –Ω–∞ –≤–∞—à–µ–º –Ω–æ–º–µ—Ä–µ
            </div>
            <div class="form-group">
                <label>–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è <span style="color: #ef4444;">*</span></label>
                <input type="text" id="verificationCode" placeholder="0000" maxlength="4" required oninput="formatVerificationCode(this)">
                <span class="error-message" id="verifyError"></span>
            </div>
            <div class="timer-container">
                <span class="timer-text">–ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω: <span id="timer">01:00</span></span>
            </div>
            <button id="verifyBtn" class="btn-submit" onclick="verifyCode()">
                <i class="fas fa-check"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É
            </button>
            <button id="resendBtn" class="btn-resend" onclick="resendCode()" style="display: none;">
                <i class="fas fa-redo"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ
            </button>
        </div>
    </div>
</div>

<!-- üî• TOAST -->
<div class="toast" id="toast">
    <i class="fas fa-check-circle"></i>
    <span id="toastMessage">Success!</span>
</div>

<script>
    // üî• GLOBAL STATE
    let currentRating = 0;
    let uploadedImages = [];
    let currentProductId = null;
    let currentOrderId = null;
    let timerInterval = null;
    let timeLeft = 60;

    // üî• CATEGORIES
    function toggleSidebar() {
        const sidebar = document.querySelector('.categories-sidebar');  // SPECIFIC TARGET
        const overlay = document.querySelector('.sidebar-overlay');
        const isActive = sidebar.classList.contains('active');

        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');

        if (!isActive) {
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = 'auto';
            // Reset categories only
            document.querySelectorAll('.category-link, .subcategory-link').forEach(link => link.classList.remove('active'));
            document.querySelectorAll('.subcategory-menu, .subsubcategory-menu').forEach(menu => menu.classList.remove('active'));
        }
    }

    function toggleCategory(el) {
        // Reset all
        document.querySelectorAll('.category-link').forEach(link => link.classList.remove('active'));
        document.querySelectorAll('.subcategory-menu, .subsubcategory-menu').forEach(menu => menu.classList.remove('active'));
        document.querySelectorAll('.subcategory-link').forEach(link => link.classList.remove('active'));

        // Activate current
        el.classList.add('active');
        const index = el.dataset.index;
        document.getElementById('subcategory-menu-' + index)?.classList.add('active');
    }

    function toggleSubCategory(el) {
        document.querySelectorAll('.subcategory-link').forEach(link => link.classList.remove('active'));
        document.querySelectorAll('.subsubcategory-menu').forEach(menu => menu.classList.remove('active'));

        el.classList.add('active');
        const catIndex = el.dataset.catIndex;
        const index = el.dataset.index;
        document.getElementById('subsubcategory-menu-' + catIndex + '-' + index)?.classList.add('active');
    }

    function sendCategoryToBackend(el) {
        const categoryName = el.dataset.name;
        window.location.href = `/?categoryName=${encodeURIComponent(categoryName)}`;
    }

    function sendSubCategoryToBackend(el) {
        const subCategoryName = el.dataset.name;
        window.location.href = `/?subCategoryName=${encodeURIComponent(subCategoryName)}`;
    }

    // üî• REVIEW MODAL
    function openReviewModal(button) {
        currentProductId = button.getAttribute('data-product-id');
        currentOrderId = button.getAttribute('data-order-id');
        document.getElementById('modalProductName').textContent = button.getAttribute('data-product-name');
        document.getElementById('modalProductImage').src = button.getAttribute('data-product-image') || '/images/placeholder.jpg';
        resetReviewForm();
        document.getElementById('reviewModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeReviewModal() {
        document.getElementById('reviewModal').classList.remove('active');
        document.body.style.overflow = 'auto';
        resetReviewForm();
    }

    // üî• PRESERVE ACTIVE SECTION WHEN FILTERING
    function filterReviews(filter) {
        // Get current active section
        const activeSection = document.querySelector('.content-section.active').id;
        // Add current section to URL to preserve it
        window.location.href = `?reviewFilter=${filter}&activeSection=${activeSection}`;
    }

    function filterOrders(filter) {
        document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
        // Get current active section
        const activeSection = document.querySelector('.content-section.active').id;
        // Add current section to URL to preserve it
        window.location.href = `?filter=${filter}&activeSection=${activeSection}`;
    }

    // üî• SET ACTIVE SECTION ON PAGE LOAD
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const activeSection = urlParams.get('activeSection');

        if (activeSection) {
            // Remove active from all
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Add active to correct section
            const targetSection = document.getElementById(activeSection);
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // Add active to nav item
            const navItem = document.querySelector(`[onclick="showSection('${activeSection}')"]`);
            if (navItem) {
                navItem.classList.add('active');
            }
        }
    });

    function setRating(rating) {
        currentRating = rating;
        const stars = document.querySelectorAll('#starRating i');
        const texts = ['', '–û—á–µ–Ω—å –ø–ª–æ—Ö–æ', '–ü–ª–æ—Ö–æ', '–ù–æ—Ä–º–∞–ª—å–Ω–æ', '–•–æ—Ä–æ—à–æ', '–û—Ç–ª–∏—á–Ω–æ!'];

        stars.forEach((star, index) => {
            star.className = index < rating ? 'fas fa-star' : 'far fa-star';
            star.style.color = index < rating ? '#f59e0b' : '#d1d5db';
        });

        const ratingText = document.getElementById('ratingText');
        ratingText.textContent = texts[rating];
        ratingText.style.color = rating >= 4 ? '#10b981' : rating >= 3 ? '#f59e0b' : '#ef4444';
        updateSubmitButton();
    }

    function updateCharCount() {
        const text = document.getElementById('reviewComment').value;
        document.getElementById('charCount').textContent = text.length;
        updateSubmitButton();
    }

    function updateAdvantagesCount() {
        document.getElementById('advantagesCount').textContent = document.getElementById('reviewAdvantages').value.length;
    }

    function updateDisadvantagesCount() {
        document.getElementById('disadvantagesCount').textContent = document.getElementById('reviewDisadvantages').value.length;
    }

    function updateSubmitButton() {
        const submitBtn = document.getElementById('submitReviewBtn');
        const hasRating = currentRating > 0;
        const hasComment = document.getElementById('reviewComment').value.trim().length >= 10;
        submitBtn.disabled = !(hasRating && hasComment);
    }

    function resetReviewForm() {
        currentRating = 0;
        uploadedImages = [];

        // Reset stars
        document.querySelectorAll('#starRating i').forEach(star => {
            star.className = 'far fa-star';
            star.style.color = '#d1d5db';
        });

        // Reset textareas
        ['reviewAdvantages', 'reviewDisadvantages', 'reviewComment'].forEach(id => {
            document.getElementById(id).value = '';
        });

        // Reset counters
        ['advantagesCount', 'disadvantagesCount', 'charCount'].forEach(id => {
            document.getElementById(id).textContent = '0';
        });

        document.getElementById('ratingText').textContent = '–ü–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É';
        document.getElementById('ratingText').style.color = '#6b7280';
        document.getElementById('imagePreviewContainer').innerHTML = '';
        updateSubmitButton();
    }

    function handleImageUpload(event) {
        const files = Array.from(event.target.files);
        if (uploadedImages.length + files.length > 6) return showToast('–ú–∞–∫—Å–∏–º—É–º 6 —Ñ–æ—Ç–æ', 'error');

        files.forEach(file => {
            if (file.size > 5 * 1024 * 1024) return showToast('–§–∞–π–ª > 5MB', 'error');
            const reader = new FileReader();
            reader.onload = e => {
                uploadedImages.push({ file, dataUrl: e.target.result });
                renderImagePreviews();
            };
            reader.readAsDataURL(file);
        });
        event.target.value = '';
    }

    function renderImagePreviews() {
        const container = document.getElementById('imagePreviewContainer');
        container.innerHTML = uploadedImages.map((img, index) => `
            <div class="image-preview">
                <img src="${img.dataUrl}" alt="Preview">
                <button class="remove-image" onclick="removeImage(${index})">&times;</button>
            </div>
        `).join('');
    }

    function removeImage(index) {
        uploadedImages.splice(index, 1);
        renderImagePreviews();
    }

    async function submitReview() {
        if (currentRating === 0) return showToast('‚≠ê –ü–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É', 'error');
        const comment = document.getElementById('reviewComment').value.trim();
        if (comment.length < 10) return showToast('–û—Ç–∑—ã–≤ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π', 'error');

        const submitBtn = document.getElementById('submitReviewBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';

        try {
            const formData = new FormData();
            formData.append('productId', currentProductId);
            formData.append('orderId', currentOrderId || '');
            formData.append('rating', currentRating);
            formData.append('comment', comment);
            formData.append('advantages', document.getElementById('reviewAdvantages').value.trim());
            formData.append('disadvantages', document.getElementById('reviewDisadvantages').value.trim());
            uploadedImages.forEach(img => formData.append('images', img.file));

            const response = await fetch('/api/reviews/add', { method: 'POST', body: formData });
            const data = await response.json();

            if (response.ok && data.success) {
                showToast('‚úÖ –û—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', 'success');
                closeReviewModal();
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(data.message || '‚ùå –û—à–∏–±–∫–∞', 'error');
            }
        } catch (error) {
            showToast('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤';
        }
    }

    // üî• PAYMENT MODAL
    function openPaymentModal(button) {
        currentOrderId = button.getAttribute('data-order-id');
        const amount = button.getAttribute('data-amount');
        document.getElementById('modalOrderId').textContent = `#${currentOrderId}`;
        document.getElementById('modalAmount').textContent = `${amount} —Å—É–º`;

        document.getElementById('paymentForm').reset();
        document.getElementById('paymentForm').style.display = 'block';
        document.getElementById('verificationSection').style.display = 'none';
        ['cardError', 'expireError', 'verifyError'].forEach(id => {
            document.getElementById(id).textContent = '';
        });

        document.getElementById('paymentModal').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closePaymentModal() {
        document.getElementById('paymentModal').classList.remove('show');
        document.body.style.overflow = 'auto';
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        document.getElementById('paymentForm').style.display = 'block';
        document.getElementById('verificationSection').style.display = 'none';
        document.getElementById('verificationCode').value = '';
    }

    function formatCardNumber(input) {
        let value = input.value.replace(/\s/g, '').replace(/\D/g, '');
        value = value.substring(0, 16);
        input.value = value.match(/.{1,4}/g)?.join(' ') || value;
        document.getElementById('cardError').textContent = '';
    }

    function formatExpireDate(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length >= 2) value = value.substring(0, 2) + '/' + value.substring(2, 4);
        input.value = value;
        document.getElementById('expireError').textContent = '';
    }

    function formatVerificationCode(input) {
        let value = input.value.replace(/\D/g, '');
        input.value = value.substring(0, 4);
        document.getElementById('verifyError').textContent = '';
    }

    async function submitPayment(event) {
        event.preventDefault();
        const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
        const expireDate = document.getElementById('expireDate').value;

        if (cardNumber.length !== 16) {
            document.getElementById('cardError').textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã (16 —Ü–∏—Ñ—Ä)';
            return;
        }
        if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expireDate)) {
            document.getElementById('expireError').textContent = '–í–≤–µ–¥–∏—Ç–µ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (MM/YY)';
            return;
        }

        const submitBtn = document.getElementById('paymentSubmitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';

        try {
            const response = await fetch('/api/orders/pay', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orderId: currentOrderId, cardNumber, expireDate })
            });
            const data = await response.json();

            if (data.success) {
                document.getElementById('paymentForm').style.display = 'none';
                document.getElementById('verificationSection').style.display = 'block';
                document.getElementById('verificationCode').focus();
                startTimer();
                showToast('‚úÖ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', 'success');
            } else {
                showToast('‚ùå ' + (data.message || '–û—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            showToast('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-lock"></i> –û–ø–ª–∞—Ç–∏—Ç—å';
        }
    }

    function startTimer() {
        timeLeft = 60;
        document.getElementById('verifyBtn').style.display = 'block';
        document.getElementById('resendBtn').style.display = 'none';

        timerInterval = setInterval(() => {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                document.getElementById('verifyBtn').style.display = 'none';
                document.getElementById('resendBtn').style.display = 'block';
            }
        }, 1000);
    }

    async function verifyCode() {
        const code = document.getElementById('verificationCode').value;
        if (code.length !== 4) {
            document.getElementById('verifyError').textContent = '–í–≤–µ–¥–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥';
            return;
        }

        const verifyBtn = document.getElementById('verifyBtn');
        verifyBtn.disabled = true;
        verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';

        try {
            const response = await fetch('/api/orders/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orderId: currentOrderId, code })
            });
            const data = await response.json();

            if (data.success) {
                showToast('‚úÖ –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞!', 'success');
                setTimeout(() => { closePaymentModal(); location.reload(); }, 1500);
            } else {
                document.getElementById('verifyError').textContent = data.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥';
            }
        } catch (error) {
            showToast('‚ùå –û—à–∏–±–∫–∞', 'error');
        } finally {
            verifyBtn.disabled = false;
            verifyBtn.innerHTML = '<i class="fas fa-check"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É';
        }
    }

    async function resendCode() {
        const resendBtn = document.getElementById('resendBtn');
        resendBtn.disabled = true;
        resendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';

        try {
            const response = await fetch('/api/orders/resend-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orderId: currentOrderId })
            });
            const data = await response.json();

            if (data.success) {
                document.getElementById('verificationCode').value = '';
                document.getElementById('verifyError').textContent = '';
                startTimer();
                showToast('‚úÖ –ù–æ–≤—ã–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', 'success');
            } else {
                showToast('‚ùå ' + (data.message || '–û—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            showToast('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
        } finally {
            resendBtn.disabled = false;
            resendBtn.innerHTML = '<i class="fas fa-redo"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ';
        }
    }

    // üî• UTILITY FUNCTIONS
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        toast.className = `toast ${type}`;
        toastMessage.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function toggleItems(header) {
        const itemsList = header.nextElementSibling;
        const icon = header.querySelector('.dropdown-icon');
        itemsList.classList.toggle('open');
        icon.classList.toggle('open');
    }

    function copyOrderId(element) {
        const orderId = element.previousElementSibling.querySelector('span').textContent;
        navigator.clipboard.writeText(orderId).then(() => {
            showToast('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!', 'success');
        });
    }

    function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
        });

        // Remove active from all nav items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });

        // Show selected section
        document.getElementById(sectionId).classList.add('active');

        // Add active to clicked nav item
        event.currentTarget.classList.add('active');

        // ‚úÖ PRESERVE IN URL (optional but recommended)
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('activeSection', sectionId);
        window.history.replaceState({}, '', `${window.location.pathname}?${urlParams}`);
    }



    // üî• INITIALIZATION
    document.addEventListener('DOMContentLoaded', function() {
        // Modal outside click
        [document.getElementById('reviewModal'), document.getElementById('paymentModal')].forEach(modal => {
            if (modal) {
                modal.addEventListener('click', e => {
                    if (e.target === e.currentTarget) {
                        if (modal.id === 'reviewModal') closeReviewModal();
                        else closePaymentModal();
                    }
                });
            }
        });

        // Escape key
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                if (document.getElementById('reviewModal').classList.contains('active')) closeReviewModal();
                if (document.getElementById('paymentModal').classList.contains('show')) closePaymentModal();
            }
        });

        // Review form listeners
        ['reviewComment', 'reviewAdvantages', 'reviewDisadvantages'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', () => {
                if (id === 'reviewComment') updateCharCount();
                else if (id === 'reviewAdvantages') updateAdvantagesCount();
                else updateDisadvantagesCount();
            });
        });
    });
</script>
</body>
</html>