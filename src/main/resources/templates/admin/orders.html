<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Orders - Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #f9f9fb; color: #222; min-height: 100vh; display: flex; flex-direction: column; }
        header { background: #fff; padding: 16px 48px; box-shadow: 0 1px 3px rgba(0,0,0,.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .logo { font-weight: 700; font-size: 20px; color: #222; text-decoration: none; }
        .nav-links { display: flex; gap: 24px; align-items: center; }
        .nav-links a { text-decoration: none; color: #555; font-weight: 500; font-size: 14px; transition: color .2s; }
        .nav-links a:hover { color: #6c3ef0; }
        .nav-links a.active { color: #6c3ef0; font-weight: 600; position: relative; }
        .nav-links a.active::after { content: ''; position: absolute; bottom: -8px; left: 0; width: 100%; height: 2px; background: #6c3ef0; border-radius: 1px; }

        main { flex-grow: 1; padding: 32px 48px; }
        .page-title { font-size: 28px; font-weight: 700; margin-bottom: 8px; color: #222; display: flex; justify-content: space-between; align-items: center; }
        .stats { display: flex; gap: 20px; margin-bottom: 32px; }
        .stat-card { background: #fff; padding: 20px 24px; border-radius: 12px; box-shadow: 0 1px 6px rgba(0,0,0,.05); flex: 1; text-align: center; }
        .stat-card .label { font-size: 14px; color: #64748b; margin-bottom: 8px; }
        .stat-card .value { font-size: 24px; font-weight: 700; color: #1e293b; }

        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; display: inline-block; }
        .status-pending { background: #fef3c7; color: #d97706; }
        .status-unpaid { background: #fee2e2; color: #dc2626; }
        .status-accepted { background: #dbeafe; color: #2563eb; }
        .status-preparing { background: #e0e7ff; color: #4f46e5; }
        .status-ready_for_pickup { background: #fef3c7; color: #d97706; }
        .status-cancelled { background: #fee2e2; color: #dc2626; }
        .status-taken_by_customer { background: #dcfce7; color: #166534; }

        .filters-container { background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 1px 6px rgba(0,0,0,.05); margin-bottom: 32px; display: flex; gap: 24px; align-items: center; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 6px; }
        .filter-group label { font-size: 13px; font-weight: 600; color: #374151; }
        .filter-input, .filter-select { padding: 12px 16px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; background: white; min-width: 200px; }
        .date-group { display: flex; gap: 12px; align-items: center; }
        .filter-btn { padding: 12px 24px; background: #6c3ef0; color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .filter-btn:hover { background: #5833c9; }
        .filter-btn-secondary { background: #f3f4f6; color: #374151; }
        .filter-btn-secondary:hover { background: #e5e7eb; }
        .clear-filters { padding: 12px 20px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 8px; font-weight: 600; cursor: pointer; }

        .table-container { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,.05); margin-bottom: 32px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 20px 16px; text-align: left; font-weight: 600; font-size: 14px; color: #374151; border-bottom: 2px solid #e5e7eb; }
        td { padding: 20px 16px; font-size: 14px; color: #374151; border-bottom: 1px solid #f3f4f6; vertical-align: top; }
        tr:hover { background-color: #f9fafb; }

        .order-id { font-weight: 600; color: #6c3ef0; }
        .customer-info { display: flex; align-items: center; gap: 12px; }
        .customer-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #6c3ef0, #a855f7); display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; font-size: 14px; }
        .items-container { max-width: 400px; }
        .item-row { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #f3f4f6; }
        .item-row:last-child { border-bottom: none; padding-bottom: 0; }
        .item-image { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; border: 1px solid #e5e7eb; }
        .item-name { font-weight: 600; color: #1f2937; font-size: 14px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-meta { display: flex; gap: 12px; font-size: 12px; color: #6b7280; flex-wrap: wrap; }
        .item-price { font-weight: 600; color: #059669; }
        .total-price { font-weight: 700; color: #1f293b; font-size: 16px; }

        .btn-taken {
            padding: 8px 16px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-taken:hover { background: #059669; transform: translateY(-1px); }
        .btn-taken:disabled { background: #6b7280; cursor: not-allowed; }

        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 32px; }
        .page-btn { padding: 10px 16px; background: #f9fafb; color: #6b7280; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; cursor: pointer; }
        .page-btn.active { background: #6c3ef0; color: white; border-color: #6c3ef0; }
        .page-btn:hover:not(:disabled) { background: #f3f4f6; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .empty-state { text-align: center; padding: 64px 20px; color: #6b7280; }
        .empty-state img { width: 100px; opacity: 0.3; margin-bottom: 24px; }

        @media (max-width: 768px) {
            main { padding: 20px; }
            .stats { flex-direction: column; }
            .filters-container { flex-direction: column; align-items: stretch; }
            .date-group { flex-direction: column; }
            .table-container { overflow-x: auto; }
            table { min-width: 800px; }
        }
    </style>
</head>
<body>
<div th:replace="fragments/header :: adminHeader(${currentWebPage})"></div>

<main>
    <div class="page-title">
        <div>Orders Management</div>
        <div class="stats">
            <div class="stat-card">
                <div class="label">Total Orders</div>
                <strong th:text="${#lists.size(orders)}" class="value">124</strong>
            </div>
            <div class="stat-card">
                <div class="label">Pending</div>
                <strong th:text="${pendingCount}" class="value">12</strong>
            </div>
            <div class="stat-card">
                <div class="label">Total Revenue</div>
                <strong th:text="${totalRevenue} + ' sum'" class="value">24,560 sum</strong>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-container">
        <div class="filter-group">
            <label>Search</label>
            <input type="text" class="filter-input" id="searchInput" placeholder="Customer name, order ID...">
        </div>

        <div class="filter-group">
            <label>Status</label>
            <select class="filter-select" id="statusFilter">
                <option value="">All Statuses</option>
                <option value="PENDING">Pending</option>
                <option value="UNPAID">Unpaid</option>
                <option value="ACCEPTED">Accepted</option>
                <option value="PREPARING">Preparing</option>
                <option value="READY_FOR_PICKUP">Ready for pickup</option>
                <option value="CANCELLED">Cancelled</option>
                <option value="TAKEN_BY_CUSTOMER">Taken by customer</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Date Range</label>
            <div class="date-group">
                <input type="date" class="filter-input" id="dateFrom">
                <input type="date" class="filter-input" id="dateTo">
            </div>
        </div>

        <button class="filter-btn" onclick="filterOrders()">Filter</button>
        <button class="filter-btn filter-btn-secondary clear-filters" onclick="clearFilters()">Clear Filters</button>
    </div>

    <!-- Orders Table -->
    <div class="table-container" th:if="${orders != null and !orders.isEmpty()}">
        <table>
            <thead>
            <tr>
                <th>Order ID</th>
                <th>Date</th>
                <th>Customer</th>
                <th>Items</th>
                <th>Total</th>
                <th>Payment</th>
                <th>Delivery</th>
                <th>Address</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="order : ${orders}" th:data-order-id="${order.id}" th:data-created-date="${order.createdAt}">
                <td class="order-id" th:text="'#' + ${order.id}"> #12345</td>

                <td>
                    <div th:text="${#temporals.format(order.createdAt, 'MMM dd, yyyy')}">Nov 15, 2024</div>
                    <div th:text="${#temporals.format(order.createdAt, 'HH:mm')}" style="font-size: 12px; color: #6b7280;">14:30</div>
                </td>

                <td>
                    <div class="customer-info">
                        <div class="customer-avatar" th:text="${order.customer.username}">JD</div>
                        <div>
                            <div th:text="${order.customer.username}">john_doe</div>
                            <div th:text="${order.customer.email}" style="font-size: 12px; color: #6b7280;">john@example.com</div>
                        </div>
                    </div>
                </td>

                <td>
                    <div class="items-container">
                        <div class="item-row" th:each="item, iter : ${order.items}" th:if="${iter.index < 3}">
                            <img th:src="${item.product.imageProducts[0]?.path ?: '/images/placeholder.jpg'}"
                                 class="item-image" />
                            <div class="item-details">
                                <div class="item-name" th:text="${item.product.name}">iPhone 15</div>
                                <div class="item-meta">
                                    <span th:text="${item.product.vendor.shopName}">TechHub</span>
                                    <span class="item-price" th:text="${item.price} + ' × ' + ${item.quantity}">999 × 1</span>
                                </div>
                            </div>
                        </div>
                        <div th:if="${#lists.size(order.items) > 3}" class="item-row"
                             style="justify-content: center; color: #6b7280; font-size: 12px;">
                            + <span th:text="${#lists.size(order.items) - 3}">2</span> more
                        </div>
                    </div>
                </td>

                <td><div class="total-price" th:text="${order.totalPrice} + ' sum'">2,450 sum</div></td>
                <td th:text="${order.payingMethod}">CASH</td>

                <td>
                    <span th:if="${order.withСourier}" style="color: #059669;">With Courier</span>
                    <span th:unless="${order.withСourier}" style="color: #6b7280;">Pickup</span>
                </td>

                <td style="max-width: 160px; font-size: 13px;" th:text="${order.address}">Tashkent...</td>

                <td>
                    <span th:classappend="'status-' + ${order.status?.name()?.toLowerCase()}"
                          th:text="${order.status}"
                          class="status-badge">READY_FOR_PICKUP</span>
                </td>
                <td>
                    <button th:if="${order.status?.name() == 'READY_FOR_PICKUP' or order.status?.name() == 'UNPAID'}"
                            class="btn-taken"
                            th:attr="data-order-id=${order.id}"
                            onclick="markAsTaken(this)">
                        Mark as Taken
                    </button>
                    <span th:unless="${order.status?.name() == 'READY_FOR_PICKUP' or order.status?.name() == 'UNPAID'}"
                          style="color: #9ca3af; font-size: 13px;">—</span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- Empty State -->
    <div class="empty-state" th:if="${orders == null or orders.isEmpty()}">
        <img src="https://cdn-icons-png.flaticon.com/512/10490/10490516.png" alt="No orders">
        <h3>No orders found</h3>
        <p>No orders match your current filters.</p>
    </div>

    <!-- Pagination (preserves filters) -->
    <div class="pagination" th:if="${totalPages > 1}">
        <button class="page-btn" th:disabled="${currentPage == 0}"
                th:onclick="|location.href='@{/admin/orders(page=${currentPage - 1}, search=${param.search}, status=${param.status}, dateFrom=${param.dateFrom}, dateTo=${param.dateTo})}'|">
            Previous
        </button>
        <button class="page-btn" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                th:classappend="${i == currentPage} ? 'active'"
                th:onclick="|location.href='@{/admin/orders(page=${i}, search=${param.search}, status=${param.status}, dateFrom=${param.dateFrom}, dateTo=${param.dateTo})}'|"
                th:text="${i + 1}">1</button>
        <button class="page-btn" th:disabled="${currentPage == totalPages - 1}"
                th:onclick="|location.href='@{/admin/orders(page=${currentPage + 1}, search=${param.search}, status=${param.status}, dateFrom=${param.dateFrom}, dateTo=${param.dateTo})}'|">
            Next
        </button>
    </div>
</main>

<script>
    // Client-side filtering — FIXED: Order ID exact match only
    let filterTimeout;

    document.getElementById('searchInput').addEventListener('input', () => {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(filterOrders, 300);
    });

    ['dateFrom', 'dateTo', 'statusFilter'].forEach(id =>
        document.getElementById(id)?.addEventListener('change', filterOrders)
    );

    function filterOrders() {
        const rawQuery = document.getElementById('searchInput').value.trim();
        const query = rawQuery.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        const rows = document.querySelectorAll('tbody tr');

        // Detect if user is searching by number → likely Order ID
        const isNumericQuery = /^\d+$/.test(rawQuery);

        rows.forEach(row => {
            // Extract data
            const orderIdText = row.querySelector('.order-id')?.textContent || ''; // e.g. "#123"
            const orderId = orderIdText.replace('#', ''); // "123"
            const customerName = (row.querySelector('.customer-info > div:nth-child(2) > div:first-child')?.textContent || '').toLowerCase();
            const customerEmail = (row.querySelector('.customer-info > div:nth-child(2) > div:nth-child(2)')?.textContent || '').toLowerCase();
            const address = (row.querySelector('td:nth-last-of-type(3)')?.textContent || '').toLowerCase();
            const status = row.querySelector('.status-badge')?.textContent || '';

            // SEARCH LOGIC
            let matchesSearch = true;

            if (query) {
                if (isNumericQuery) {
                    // If pure number → match only if Order ID ends with or equals the number
                    matchesSearch = orderId.endsWith(query) || orderId === query;
                } else {
                    // Text search → customer name, email, address
                    matchesSearch = customerName.includes(query) ||
                        customerEmail.includes(query) ||
                        address.includes(query);
                }
            }

            // STATUS FILTER
            const matchesStatus = !statusFilter || status === statusFilter;

            // DATE FILTER
            let matchesDate = true;
            const orderDateStr = row.getAttribute('data-created-date');
            if ((dateFrom || dateTo) && orderDateStr) {
                const orderDate = new Date(orderDateStr);
                if (dateFrom) {
                    const fromDate = new Date(dateFrom + 'T00:00:00');
                    matchesDate &&= orderDate >= fromDate;
                }
                if (dateTo) {
                    const toDate = new Date(dateTo + 'T23:59:59');
                    matchesDate &&= orderDate <= toDate;
                }
            }

            // Show/hide row
            row.style.display = (matchesSearch && matchesStatus && matchesDate) ? '' : 'none';
        });
    }

    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        filterOrders();
        window.location.href = '/admin/orders';
    }

    // Default date range: last 30 days
    document.getElementById('dateTo').valueAsDate = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    document.getElementById('dateFrom').valueAsDate = thirtyDaysAgo;

    // MARK AS TAKEN BUTTON
    function markAsTaken(button) {
        const orderId = button.getAttribute('data-order-id');
        if (!confirm(`Mark order #${orderId} as taken by customer?`)) return;

        button.disabled = true;
        button.textContent = 'Saving...';

        fetch(`/admin/orders/${orderId}/taken`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || ''
            }
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const badge = button.closest('tr').querySelector('.status-badge');
                    badge.textContent = 'TAKEN_BY_CUSTOMER';
                    badge.className = 'status-badge status-taken_by_customer';
                    button.remove();
                    showToast('Order marked as taken!', 'success');
                } else {
                    throw new Error(data.message || 'Failed');
                }
            })
            .catch(err => {
                console.error(err);
                button.disabled = false;
                button.textContent = 'Mark as Taken';
                showToast('Error: ' + err.message, 'error');
            });
    }

    function showToast(msg, type = 'success') {
        const toast = document.createElement('div');
        toast.textContent = msg;
        toast.style.cssText = `
            position:fixed;top:20px;right:20px;padding:12px 20px;
            border-radius:8px;color:#fff;font-weight:600;z-index:10000;
            background:${type==='success'?'#10b981':'#ef4444'};
            box-shadow:0 10px 25px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease;
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // Optional: add fade-in animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
</script>
</body>
</html>