<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - ShopFlow</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        .nav-links a.active {
            color: #6c3ef0;
            font-weight: 600;
            position: relative;
        }
        .nav-links a.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #6c3ef0;
            border-radius: 1px;
        }
        * { box-sizing: border-box; }
        body { margin:0; font-family:'Inter',sans-serif; background:#f9f9fb; color:#222; min-height:100vh; display:flex; flex-direction:column; }
        header { background:#fff; padding:16px 48px; box-shadow:0 1px 3px rgba(0,0,0,.05); display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:10; }
        .logo { font-weight:700; font-size:20px; color:#222; text-decoration:none; }
        .nav-links { display:flex; gap:24px; align-items:center; }
        .nav-links a { text-decoration:none; color:#555; font-weight:500; font-size:14px; transition:color .2s; }
        .nav-links a:hover { color:#6c3ef0; }
        .admin-badge { background:#6c3ef0; color:#fff; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600; }
        main { flex-grow:1; padding:32px 48px; }
        .page-title { font-size:24px; font-weight:700; margin-bottom:24px; color:#222; display:flex; justify-content:space-between; align-items:center; }
        .grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); gap:20px; margin-bottom:32px; }
        .card { background:#fff; padding:20px; border-radius:12px; box-shadow:0 1px 6px rgba(0,0,0,.05); }
        .card h3 { margin:0 0 8px; font-size:14px; color:#666; font-weight:500; }
        .card .value { font-size:28px; font-weight:700; color:#222; }
        .card .trend { font-size:12px; color:#22c55e; }
        .card .trend.down { color:#ef4444; }
        .chart-container { background:#fff; padding:20px; border-radius:12px; box-shadow:0 1px 6px rgba(0,0,0,.05); margin-bottom:32px; }
        .chart-container h3 { margin:0 0 16px; font-size:16px; font-weight:600; color:#222; }
        .activity { background:#fff; padding:20px; border-radius:12px; box-shadow:0 1px 6px rgba(0,0,0,.05); }
        .activity h3 { margin:0 0 16px; font-size:16px; font-weight:600; color:#222; }
        .activity-item { display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #eee; font-size:14px; }
        .activity-item:last-child { border-bottom:none; }
        .activity-item .action { font-weight:600; }
        .activity-item .time { color:#888; font-size:12px; }
        .btn { padding:10px 16px; border:none; border-radius:8px; font-weight:600; font-size:14px; cursor:pointer; transition:all .2s; }
        .btn-primary { background:#6c3ef0; color:#fff; }
        .btn-primary:hover { background:#5833c9; }
        .lang-toggle { background:none; border:none; cursor:pointer; font-size:14px; color:#6c3ef0; }
        @media (max-width:768px) {
            header { padding:16px; flex-direction:column; gap:12px; }
            main { padding:20px; }
            .page-title { flex-direction:column; align-items:flex-start; gap:12px; }
        }
    </style>

    <script>
        const socket = new WebSocket('ws://' + location.host + '/ws/vendor-updates');

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            const action = data.action;
            const shopName = data.shopName;

            // Show toast
            showToast(`${action}: "${shopName}"`, action === 'APPROVED' ? 'success' : 'error');

            // If on vendor_accept page → remove row
            if (window.location.pathname.includes('vendor_accept')) {
                const row = document.querySelector(`tr[data-vendor-id="${data.vendorId}"]`);
                if (row) row.remove();
                updatePendingCount();
            }

            // If on dashboard → add to recent activity
            if (window.location.pathname.includes('dashboard')) {
                addActivityLog(data);
            }
        };

        function showToast(msg, type) {
            const toast = document.createElement('div');
            toast.textContent = msg;
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.right = '20px';
            toast.style.padding = '12px 20px';
            toast.style.borderRadius = '8px';
            toast.style.color = '#fff';
            toast.style.fontWeight = '600';
            toast.style.zIndex = '1000';
            toast.style.background = type === 'success' ? '#22c55e' : '#ef4444';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function updatePendingCount() {
            const countEl = document.querySelector('.stats-card span');
            if (countEl) {
                let count = parseInt(countEl.textContent) || 0;
                if (count > 0) countEl.textContent = count - 1;
            }
        }

        function addActivityLog(data) {
            const list = document.querySelector('.activity');
            if (!list) return;

            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `
            <div>
                <span class="action">${data.action}</span>
                <span>${data.shopName}</span>
            </div>
            <div class="time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        `;
            list.insertBefore(item, list.firstChild);
        }
    </script>
</head>
<body>

<div th:replace="fragments/header :: adminHeader(${currentPage})"></div>

<main>
    <div class="page-title">
        <div>Admin Dashboard</div>
        <button class="btn btn-primary" th:onclick="|location.href='@{/admin/vendor_accept}'|">Go to Approvals</button>
    </div>

    <!-- Stats Grid -->
    <div class="grid">
        <div class="card">
            <h3>Total Vendors</h3>
            <div class="value" th:text="${stats.totalVendors}">124</div>
            <div class="trend">+12 this month</div>
        </div>
        <div class="card">
            <h3>Pending Approval</h3>
            <div class="value" th:text="${stats.pendingVendors}">8</div>
            <div class="trend down">-3 today</div>
        </div>
        <div class="card">
            <h3>Approved Vendors</h3>
            <div class="value" th:text="${stats.approvedVendors}">116</div>
            <div class="trend">+15 this week</div>
        </div>
        <div class="card">
            <h3>Total Users</h3>
            <div class="value" th:text="${stats.totalUsers}">1,842</div>
            <div class="trend">+89 today</div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid" style="grid-template-columns: 1fr 1fr;">
        <!-- Vendor Growth (Last 7 Days) -->
        <div class="chart-container">
            <h3>Vendor Growth (Last 7 Days)</h3>
            <canvas id="vendorChart"></canvas>
        </div>

        <!-- User Roles (pie) -->
        <div class="chart-container">
            <h3>User Roles</h3>
            <canvas id="roleChart"></canvas>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="activity">
        <h3>Recent Activity</h3>
        <div th:each="log : ${recentLogs}" class="activity-item">
            <div>
                <span class="action" th:text="${log.action}">Approved</span>
                <span th:text="${log.shopName}">TechStore</span>
            </div>
            <div class="time" th:text="${#temporals.format(log.timestamp, 'HH:mm, dd MMM')}">14:32, 15 Nov</div>
        </div>
        <div th:if="${#lists.isEmpty(recentLogs)}" style="text-align:center; color:#999; padding:20px;">
            No recent activity.
        </div>
    </div>
</main>

<script th:inline="javascript">
    /*<![CDATA[*/

    // ---- Vendor Growth (last 7 days) ----
    // You can replace this with a real service call or pass a list from the controller.
    // For now we just show a placeholder that uses the total-vendor count.
    const vendorGrowthData = /*[[ ${vendorGrowth} ]]*/ [0,0,0,0,0,0,0];
    const totalVendors = /*[[ ${stats.totalVendors} ]]*/ 0;

    const vendorCtx = document.getElementById('vendorChart').getContext('2d');
    new Chart(vendorCtx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'New Vendors',
                data: vendorGrowthData,
                borderColor: '#6c3ef0',
                backgroundColor: 'rgba(108, 62, 240, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        afterLabel: function(ctx) {
                            return 'Total vendors: ' + totalVendors;
                        }
                    }
                }
            }
        }
    });

    // ---- User Roles (pie) ----
    const roleStats = /*[[ ${roleStats} ]]*/ {customers:0, vendors:0, admins:0};

    const roleCtx = document.getElementById('roleChart').getContext('2d');
    new Chart(roleCtx, {
        type: 'doughnut',
        data: {
            labels: ['Customers', 'Vendors', 'Admins'],
            datasets: [{
                data: [roleStats.customers, roleStats.vendors, roleStats.admins],
                backgroundColor: ['#e0e7ff', '#6c3ef0', '#22c55e'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            const label = ctx.label || '';
                            const value = ctx.raw || 0;
                            const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
                            const percent = total ? Math.round(value/total*100) : 0;
                            return `${label}: ${value} (${percent}%)`;
                        }
                    }
                }
            }
        }
    });

    /*]]>*/
    // Language Toggle (UZ / EN)
    let isUz = false;
    function toggleLang() {
        isUz = !isUz;
        document.querySelectorAll('[data-uz]').forEach(el => {
            el.textContent = isUz ? el.getAttribute('data-uz') : el.getAttribute('data-en');
        });
        document.querySelector('.lang-toggle').textContent = isUz ? 'English' : "O'zbekcha";
    }

    // Auto-hide messages
    setTimeout(() => {
        const msg = document.querySelector('.message');
        if (msg) msg.remove();
    }, 5000);
</script>

<!-- Uzbek Translations -->
<script>
    document.querySelectorAll('[data-en]').forEach(el => {
        el.setAttribute('data-uz', el.textContent.replace(/Dashboard/g, "Boshqaruv paneli")
            .replace(/Vendor Approval Requests/g, "Do'kon tasdiqlash")
            .replace(/Pending Approval/g, "Kutilmoqda")
            .replace(/Total Vendors/g, "Jami do'konlar")
            .replace(/Approved Vendors/g, "Tasdiqlangan")
            .replace(/Total Users/g, "Jami foydalanuvchilar")
            .replace(/Recent Activity/g, "So'nggi harakatlar")
            .replace(/Approved/g, "Tasdiqlangan")
            .replace(/Rejected/g, "Rad etilgan"));
    });
</script>

</body>
</html>